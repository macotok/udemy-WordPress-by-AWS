# 【CloudWatch】システムを監視

## システム監視とは

- システムが正常な状態を保てるよう稼働状況やリソースを監視すること
- サーバーが正常に稼働しているか監視
- サーバーのCPUやメモリが枯渇、問題ないかのリソースを監視
- 目的
    - すぐに障害発生を確認できるようにする
    - 復旧にすぐに取りかかれるようにする
 
 ### システム監視の設定と運用
 
 - 「正常な状態」「正常な結果」を監視項目で定義する
    - 例 CPU使用率60%以下が正常
 - 「正常な状態」でなくなったときの対応方法を監視項目ごとに定義する
    - 例 CPU使用率が60%を超えたらサーバーを1台増やす
 - 「正常な状態」であることを継続的に確認する
    - 例 1分に1回モニタリングする
 - 「正常な状態」でなくなった場合に通知が届くように設定し、すぐに「正常な状態」に復旧させる
 
 ## 監視の種類
 
 - 死活監視
    - 正常にシステムが動作しているかを確認。サーバーやシステムが落ちてないか
 - メトリクス監視
    - パフォーマンスを定量的に監視。サーバーのリソース状況など
    - 指標を決め、指標が閾値以上・以下になっているかを把握
    
 ## 監視する際のポイント
 
 - システムや利用状況は変わるので、足りない監視を都度足していく
 - 項目が多すぎると監視疲れ、面倒になる
 - 最初は基本的な要素のみ監視
    - CPU、メモリ、Disk、ネットワークの使用率

## CloudWatchとは

- AWSサービスをモニタリングできる運用監視のマネージドサービス
- AWSサービスのメトリクスを監視
- メトリクスに対して閾値を登録し、その条件を満たしたら通知する
- 通知サービスでAmazon SNSを使用
    - Publisher、Subscriberの構図
    - CloudWatchやEC2がAmazon SNSに対してメッセージを送信(Publisher)
    - スマホやEmail、EC2で通知を受信(Subscriber)
    - それらを管理しているのがAmazon SNS
    - Amazon SNSはどこからどこへの通知かをトピックを作成して管理する

## CloudWatchの設定

|  画面  |  押下 |
| ---- | ---- |
|  サービス/CloudWatch/アラーム　|  アラームの作成 |

- メトリクスの選択
    - EC2
    - `すべてのメトリクス`から「CPUUtilization」を選択。(CPU使用率のメトリクス)
- メトリクスと条件の指定
    - `期間`を「1分」に設定
    - `CPUUtilization が次の時...`で「以上」を選択
    - `... よりも`を「60」に入力
    - 上記はCPU使用率が60%を超えたらアラーム通知する設定
- アクションの設定
    - `SNS トピックの選択`は「新しいトピックの作成」を選択
    - 新規トピック名を入力
    - `通知を受け取る E メールエンドポイント`を入力
 - 名前と説明を追加
    - `アラーム名`を入力
    - `アラームの説明 - オプション`を入力

## CloudWatchのアラートを確認

- `$ yes > /dev/null &`コマンドで意図的にCPUを上げさせる
- `$ top`コマンドでCPU使用率を確認
- CPU使用率が60%を超えると`CloudWatch/アラーム`のアラーム一覧リストに記載され、メール通知が届く

SSHログイン
```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```

意図的にCPUを上げさせる
```terminal
[ec2-user@ip-10-0-10-10 ~]$ yes > /dev/null &
```

CPU使用率を確認
```terminal
[ec2-user@ip-10-0-10-10 ~]$ top
```

### 後片付け

grepコマンドで`yes`プロセスを検索
```terminal
[ec2-user@ip-10-0-10-10 ~]$ ps aux | grep yes
```

killコマンドでプロセスIDを停止
```terminal
[ec2-user@ip-10-0-10-10 ~]$ kill -9 {プロセスID}
```
