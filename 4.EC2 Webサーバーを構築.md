# EC2 Webサーバーを構築

## EC2とは
- Elastic Compute Cloudの略。AWSクラウド上の仮想サーバー
- インスタンスというのはEC2から立てられたサーバーのこと
- 数分で起動。1時間または秒単位の従量課金
- サーバーの追加、削除、マシンスペック変更も数分で可能
- OSより上のレイヤについては自由に設定できる

## EC2の作成手順
- AMIの選択
- インスタンスタイプの選択
- ストレージの追加
- セキュリティグループの設定
- SSHキーペアの設定

## AMIとは
- Amazon Machine Imageの略。インスタンス起動に必要な情報が入ったOSのイメージ
- サーバーのテンプレートのようなもの
- AWSやサードパーティがAMMIを提供
- 自前のカスタムAMIも作成可能
- カスタムAMIから何台でもEC2インスタンスを起動可能

## インスタンスタイプとは
- サーバーのスペックを定義したもの
- インスタンスタイプにより、CPU、メモリ、ストレージ、ネットワーク帯域が異なる
- インスタンスタイプにより料金が異なる。スペックが高いほど料金も高い
- アクセス数などに応じて必要なスペックのあるインスタンスタイプを選択する
- インスタンスタイプ例 m5.xlarge。インスタンスファミリー(m)、インスタンス世代(5)、インスタンスサイズ(xllarge)

## ストレージとは
- サーバーにくっつけるデータの保存場所
- EC2のストレージには`EBS`と`インスタンスストア`の2種類ある

## EBSとは
- 高い可用性と耐久性を持つストレージ
- 他のインスタンスに付け替え可能
- EC2インスタンスをStop/TerminateしてもEBSは保持可能
- Snapshotを取得しS3に保存可能
- EBSの費用が別途発生
- OSやDBなどの永続性と耐久性が必要なデータを置く
- 通常の利用ケースはEBSを選択

## インスタンスストアとは
- インスタンス専用の一時的なストレージ
- 他のインスタンスに付け替えることができない
- EC2インスタンスをStop/Terminateするとクリアされる
- 追加費用なし(無料)
- なくなってはいけないデータは置かない
- 一時ファイル、キャッシュなど、失われても問題がないデータを置く

## EC2インスタンスを設置
- サービス/EC2/インスタンス
- インスタンスの作成

## AMIの選択
- クイックスタート`Amazon Linux 2 AMI`を選択
- AWSによってメンテナンスされてるLinux
- AWSの各サービスを連携するためのツールやライブラリが入ってる
- 特に要件がなければ選択

## インスタンスタイプの選択
- インスタンスタイプは無料利用枠の`t2.micro`を選択(動作確認で十分なので)
- インスタンスの詳細の設定
  - ネットワークは作成したVPCを選択
  - サブネットはパブリックサブネットを選択(パブリックサブネットにEC2を設置するため)
  - 自動割り当てパブリックIPはインターネット経由でアクセスするグローバルIPアドレスにしたいので`有効`を選択
  - キャパシティの予約はアベイラビリティゾーンごとに利用するリソースが決まっている。それを超えるとEC2インスタンスの起動ができない。キャパシティ予約すると事前にリソースを確保してくれる。EC2インスタンスの利用有無に関係なく料金が発生する。`なし`を選択
  - 終了保護の有効化は本番環境の場合にチェックを入れる
  - T2/T3無制限はバーストモードを無制限にする。バーストモード中は料金が発生
  - ネットワークインターフェイスのパブリックサブネットのプライマリIPを`10.0.10.10`に設定

## ストレージの追加
- ボリュームタイプが`ルート`はOSが入っているストレージ
- デバイスはOSから見えるデバイス名。ルートのときは変更できない
- スナップショットはストレージの中身となるもの
- ボリュームタイプの汎用SSDは規格とパフォーマンスのバランスが取れているので多くの場合こちらを選択。プロビジョンドIOPSはDBなど高いIOが必要なとき選択
- `合わせて削除`はインスタンスを削除するとEBSも削除するか。無駄な課金を避けるためにチェック

## 新しいキーペアの作成
- タグの追加、セキュリティグループの設定が終わるとキーペアを作成する
- サーバーにSSHログインするために必要

## SSHログインについて
- 離れた場所にあるサーバーに入って自分のパソコンから操作すること

## SSHとは
- サーバーと自分のパソコンをセキュアにつなぐサービスのこと
- 通信内容が暗号化された遠隔ログインシステム
- ログインする側をSSHクライアント
- ログインされる側をSSHサーバー
- 通信内容が暗号化されているので第三者が介入できない

## 公開鍵認証について
- サーバーの作成者本人だけがログインできるようSSHログイン時に公開鍵認証を行っている
- サーバーへのログイン時に認証を行う仕組み
- ユーザー名とパスワードを使用した認証と比べセキュリティが高い
- 公開鍵暗号(秘密鍵と公開鍵)を用いて認証を行う
- 公開鍵はサーバーが保有
- 秘密鍵を持っているユーザーだけがログイン可能

## 公開鍵暗号
- 暗号とは他の人には内容を分からないようにしてメッセージのやり取りを行うのが暗号
- 南京錠をイメージ。誰でもロックができる。南京錠を解除するには鍵が必要
- メッセージを公開鍵で暗号化(暗号文)
- メッセージを秘密鍵で復号化(平文に)

## SSHログイン

- 作成したキーペア(秘密鍵)をオーナー以外が使用できないように読み書き権限を行う
```terminal
$ chmod 600 {秘密鍵}.pem
```
- EC2/インスタンス　作成したインスタンスを選択
- IPv4パブリックIPをコピー(パブリックIPアドレス)
- sshにログイン
```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```
- サーバーとの接続を切るには`exit`

## ポート番号とは
- SSHでログインしてサーバーを操作できるのはサーバー上でSSH接続を受け入れ、ユーザーからのコマンドを受け付けるプログラム(sshd)が動いてるから
-　ポート番号はプログラムのアドレス。同一コンピューター内で通信を行うプログラムを識別するときに利用
- SSHサーバーのポート番号は22
- HTTPサーバーのポート番号は80
- SMTPサーバーのポート番号は25

## ポート番号はどうやって決まっているのか
- 標準で決められている番号と動的に決まる番号の2種類ある

## 標準で決められているポート番号
- 代表的なプログラムが使うポート番号はあらかじめ決められている
- ウェルノウンポート番号と呼ばれる
- ウェルノウンポート番号は0〜1023までのいずれかの整数値
- SSHは22番、SMTPは25番、HTTPは80番、HTTPSは443番
- 接続元(クライアント)が接続先のポート番号を省略したときはこのウェルノウンポート番号が使用される

## 動的に決まるポート番号
- サービスを提供する側(サーバー)はポート番号が決まっている必要があるが、接続元(クライアント)のポート番号は決まってなくてもいい
- クライアントのポート番号は、OSが他のポート番号と被らないようにランダムに決める
- 動的に割り当てる番号は49142〜65535までのいずれかの整数値

## 各プログラムのポート番号を確認
- sshにログイン
```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```
- 各プログラムのポート番号を調べる
```terminal
$ sudo lsof -i -n -P
```
-  NAMEに`(LISTEN)`は他のコンピューターから待ち受けているプログラム
- `(ESTABLISHED)`は相手と通信中のプログラム
- NAMEに`*`はどの接続元でも受け付けるプログラム

## Apacheをインストール

- sshにログイン
```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```
- EC2のパッケージ(yum)をupdate
```terminal
$ sudo yum update -y
```
- sudoはrootユーザーの権限で実行
- Apacheをinstall
```terminal
$ sudo yum -y install httpd
```
- Apacheを起動
```terminal
$ sudo systemctl start httpd.service
```
- `systemctl`はプログラム起動停止を行うコマンド
- Apacheが起動しているか確認
```terminal
$ sudo systemctl status httpd.service
```
`Active: active (running)`と表示されてれば起動
- 全てのプロセスを表示でApacheが起動しているか確認
```terminal
$ ps -axu

$ ps -axu | grep httpd
```
- Apacheを自動起動
```terminal
$ sudo systemctl enable httpd.service
```
- 自動起動されているか確認
```terminal
$ sudo systemctl is-enabled httpd.service
```
