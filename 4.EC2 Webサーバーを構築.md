# EC2 Web サーバーを構築

## EC2 とは

- Elastic Compute Cloud の略。AWS クラウド上の仮想サーバー
- インスタンスは EC2 から立てられたサーバーのこと
- 数分で起動できる
- 1 時間または秒単位の従量課金
- サーバーの追加、削除、マシンスペック変更も数分で可能
- OS より上のレイヤについては自由に設定できる

### EC2 の作成手順

1. AMI の選択
2. インスタンスタイプの選択
3. ストレージの追加
4. セキュリティグループの設定
5. SSH キーペアの設定

## AMI とは

- Amazon Machine Image の略。インスタンス起動に必要な情報が入った OS
- サーバーのテンプレートのようなもの
- AWS やサードパーティが AMI を提供
- 自前のカスタム AMI も作成可能
- カスタム AMI から何台でも EC2 インスタンスを起動可能

## インスタンスタイプとは

- サーバーのスペックを定義したもの
- インスタンスタイプによって CPU、メモリ、ストレージ、ネットワーク帯域が異なる
- インスタンスタイプによって料金が異なる。スペックが高いほど料金も高い
- アクセス数などに応じて必要なスペック分のインスタンスタイプを選択する
- インスタンスタイプの例「m5.xlarge」インスタンスファミリー(m)、インスタンス世代(5)、インスタンスサイズ(xlarge)

## ストレージとは

- サーバーにくっつけるデータの保存場所
- EC2 のストレージには「EBS」と「インスタンスストア」の 2 種類ある

### インスタンスストアと EBS の違い

- インスタンスストア
  - ホストコンピューターに内蔵されたディスクで EC2 と不可分のブロックレベルの物理ストレージ
  - EC2 の一時的なデータが保持され、EC2 の停止・終了とともにデータがクリアされる
  - 無料
- EBS
  - ネットワークで接続されたブロックレベルのストレージで EC2 とは独立管理
  - EC2 を終了しても EBS データは保持可能
  - Snapshot を S3 に保持可能
  - 別途 EBS 料金が必要

### EBS とは

- 高い可用性と耐久性を持つストレージ
- 同じ AZ 内のインスタンスのみ他のインスタンスに付け替え可能
- EC2 インスタンスを Stop/Terminate しても EBS は保持可能
- Snapshot を取得し S3 に保存可能
- Snapshot はリージョン間をまたいで利用可能。リージョン間で Snapshot をコピー
- Snapshot は権限を変更することで他のアカウントに移譲可能
- EBS の費用が別途発生
- OS や DB などの永続性と耐久性が必要なデータを置く
- 通常の利用ケースは EBS を選択
- サイズは 1GB〜16TB
- サイズと利用期間で課金される
- 他の AZ のインスタンスにアタッチできない
- １つの EBS を複数のインスタンスで基本共有できない(プロビジョンド IOPS のみ可能)

### EBS の RAID 構成

- RAID0
  - パフォーマンスを向上させることを目的とする
  - 複数のディスクを 1 台のディスクのように扱い読み書きを高速化する
  - ストライピング
- RAID1
  - ボリュームの冗長性を高めることを目的とする
  - 2 つのボリュームを同時にミラーリングする

### ストレージサービスの種類

- ブロックストレージ
  - EC2 にアタッチして活用するディスクサービス
  - ブロック形式でデータを保存
  - 高速・広帯域幅
  - 例: EBS、インスタンスストア
- オブジェクトストレージ
  - 安価かつ高い耐久性を持つオンラインストレージ
  - オブジェクト形式でデータを保存
  - デフォルトで複数 AZ に冗長化されている
  - 例: S3、Glacier
- ファイルストレージ
  - 複数の EC2 インスタンスから同時にアタッチ可能な共有ストレージサービス
  - ファイル形式でデータを保存
  - 例: EFS

### インスタンスストアとは

- インスタンス専用の一時的なストレージ
- 他のインスタンスに付け替えることができない
- EC2 インスタンスを Stop/Terminate するとクリアされる
- 追加費用なし(無料)
- 失なってはいけないデータは置かない
- 一時ファイル、キャッシュなど失われても問題がないデータを置く

## EC2 インスタンスを設置

| 画面                      | 押下               |
| ------------------------- | ------------------ |
| サービス/EC2/インスタンス | インスタンスの作成 |

### AMI の選択

- クイックスタート
  - 「Amazon Linux 2 AMI」を選択
  - 「Amazon Linux 2 AMI」とは
    - AWS によってメンテナンスされてる Linux
    - AWS の各サービスを連携するためのツールやライブラリが入ってる
    - 特に要件がなければ選択

### インスタンスタイプの選択

- インスタンスタイプは無料利用枠の「t2.micro」を選択(動作確認で十分な場合)
- インスタンスの詳細設定
  - `ネットワーク`は作成した VPC を選択
  - `サブネット`は作成したパブリックサブネットを選択(パブリックサブネットに EC2 を設置するため)
  - `自動割り当てパブリックIP`は「有効」を選択(インターネット経由でアクセスするグローバル IP アドレスにするため)
  - `キャパシティの予約`は「なし」を選択
    - アベイラビリティゾーンごとに利用するリソースが決まっている
    - それを超えると EC2 インスタンスの起動ができない
    - キャパシティ予約すると事前にリソースを確保してくれる
    - EC2 インスタンスの利用有無に関係なく料金が発生する
  - `終了保護の有効化`は本番環境の場合はチェックを入れる
  - `T2/T3無制限`はチェックなし
    - バーストモードを無制限にする
    - バーストモード中は料金が発生。
  - ネットワークインターフェイス
    - パブリックサブネットの`プライマリIP`を「10.0.10.10」に設定
- bash コマンドを挿入
  - `高度な詳細`に bash コマンドを挿入
  - インスタンス起動時に実行するコマンド

### ストレージの追加

- `ボリュームタイプ`の「ルート」は OS が入っているストレージ
- `デバイス`は OS から見えるデバイス名。ルートのときは変更することができない
- `スナップショット`はストレージの中身となるもの
- `ボリュームタイプ`の「汎用 SSD」は規格とパフォーマンスのバランスが取れているので多くの場合こちらを選択
  - 「プロビジョンド IOPS」は DB など高い IO が必要なとき選択
- `終了時に削除`にチェックを入れる
  - インスタンスを削除すると EBS も削除するかどうか
  - 無駄な課金を避けるためにチェックを入れる

### 新しいキーペアの作成

- 「タグの追加」「セキュリティグループの設定」を押下するとキーペアを作成する
- サーバーに SSH ログインするために必要

## SSH ログインについて

- 自分のパソコンから離れた場所にあるサーバーに入って操作すること

### SSH とは

- サーバーと自分のパソコンをセキュアにつなぐサービスのこと
- 通信内容が暗号化された遠隔ログインシステム
- ログインする側を SSH クライアント
- ログインされる側を SSH サーバー
- 通信内容が暗号化されているので第三者が介入できない

## 公開鍵認証とは

- サーバーの作成者本人だけがログインできるように SSH ログイン時に公開鍵認証を行っている
- サーバーへのログイン時に認証を行う仕組み
- ユーザー名とパスワードを使用した認証と比べセキュリティが高い
- 公開鍵暗号(秘密鍵と公開鍵)を用いて認証を行う
  - 公開鍵はサーバーが保有
  - 秘密鍵を持っているユーザーだけがログイン可能

### 公開鍵暗号

- 暗号とは他の人には内容を分からないようにしてメッセージのやり取りを行うこと
- 南京錠をイメージ
  - 誰でもロックができる
  - 南京錠を解除するには鍵が必要
- メッセージを公開鍵で暗号化(暗号文)
- メッセージを秘密鍵で復号化(平文に)

## SSH ログイン

作成したキーペア(秘密鍵)をオーナー以外が使用できないように読み書き権限を行う

```terminal
$ chmod 600 {秘密鍵}.pem
```

| 画面                      | 選択                 |
| ------------------------- | -------------------- |
| サービス/EC2/インスタンス | 作成したインスタンス |

- 「IPv4 パブリック IP」をコピー(パブリック IP アドレス)

ssh にログイン

```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```

- サーバーとの接続を切るには`exit`

## ポート番号とは

- SSH でログインしてサーバーを操作できるのはサーバー上で SSH 接続を受け入れ、ユーザーからのコマンドを受け付けるプログラム(sshd)が動いてるから
- ポート番号はプログラムのアドレス。同一コンピューター内で通信を行うプログラムを識別するときに利用
  - SSH サーバーのポート番号は 22
  - HTTP サーバーのポート番号は 80
  - SMTP サーバーのポート番号は 25

### ポート番号はどうやって決まっているのか

- 標準で決められている番号と動的に決まる番号の 2 種類存在する

#### 標準で決められているポート番号

- 代表的なプログラムはポート番号があらかじめ決められている
- ウェルノウンポート番号と呼ばれる
- ウェルノウンポート番号は 0〜1023 までのいずれかの整数値
- SSH は 22 番、SMTP は 25 番、HTTP は 80 番、HTTPS は 443 番
- 接続元(クライアント)が接続先のポート番号を省略したときはこのウェルノウンポート番号が使用される

#### 動的に決まるポート番号

- サービスを提供する側(サーバー)はポート番号が決まっている必要があるが、接続元(クライアント)のポート番号は決まってなくてもいい
- クライアントのポート番号は OS が他のポート番号と被らないようにランダムに決める
- 動的に割り当てる番号は 49142〜65535 までのいずれかの整数値

### 各プログラムのポート番号を確認

ssh にログイン

```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```

各プログラムのポート番号を調べる

```terminal
$ sudo lsof -i -n -P
```

- NAME の`(LISTEN)`は他のコンピューターから待ち受けているプログラム
- `(ESTABLISHED)`は相手と通信中のプログラム
- NAME の`*`はどの接続元でも受け付けるプログラム

## Apache をインストール

ssh にログイン

```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```

EC2 のパッケージ(yum)を update

```terminal
$ sudo yum update -y
```

- sudo は root ユーザーの権限で実行

Apache を install

```terminal
$ sudo yum -y install httpd
```

Apache を起動

```terminal
$ sudo systemctl start httpd.service
```

- `systemctl`はプログラム起動停止を行うコマンド

Apache が起動しているか確認

```terminal
$ sudo systemctl status httpd.service
```

- `Active: active (running)`と表示されていれば起動

全てのプロセス表示

```terminal
$ ps -axu
```

Apache が起動しているか確認

```terminal
$ ps -axu | grep httpd
```

Apache を自動起動に設定

```terminal
$ sudo systemctl enable httpd.service
```

自動起動されているか確認

```terminal
$ sudo systemctl is-enabled httpd.service
```

## ファイアウォールを設定

- ファイアウォールとはネットワークを不正アクセスから守る
- 通してよい通信だけを通す。それ以外は通さない

### AWS におけるファイアウォール

- AWS ではセキュリティグループがファイアウォールの役割を担ってる
- サーバーへ入ってくる通信をインバウンド
- サーバーから出ていく通信をアウトバウンド
  - インバウンドのポートは必要なものだけを開ける
  - アウトバウンドのポートは多くの場合、全て開いている

## セキュリティグループのポート番号 80 番(http)を開ける

- 現状、サービス/EC2/インスタンスの`IPv4 パブリック IP`の URL を Web ブラウザで開くことはできない(応答がない)

| 画面                      | 選択                      |
| ------------------------- | ------------------------- |
| サービス/EC2/インスタンス | 作成した EC2 インスタンス |

- `セキュリティグループ`の作成した EC2 インスタンスを押下
- `インバウンドルール`が SSH の 22 番と記載されている。SSH 以外はインバウンドされない
- 「インバウンドルールの編集」を押下
- 「ルールを追加する」を押下
  - `タイプ`で「HTTP」を選択
  - `ソース`を「任意の場所で保存」を選択
- `IPv4 パブリック IP`の URL で Apache のデフォルトページが表示されることを確認

## Elastic IP アドレスでパブリック IP アドレスを固定

- EC2 インスタンスのパブリック IP は起動・停止する度に別の IP アドレスが割り当てられる。動的に変わる
- Elastic IP アドレスを使用すると IP アドレスが固定される

### Elastic IP アドレスとは

- インターネット経由でアクセス可能な固定グループ IP アドレスが取得できて、インスタンスに付与できるサービス
- インスタンスを削除するまではその IP アドレスを使用できる
- Elastic IP アドレスは EC2 インスタンスに関連付けられていて、そのインスタンスが起動中であれば無料。起動してない場合は課金される

### Elastic IP アドレスを EC2 インスタンスに紐付ける

| 画面                    | 押下                          |
| ----------------------- | ----------------------------- |
| サービス/EC2/Elastic IP | Elastic IP アドレスの割り当て |

- Elastic IP アドレスの割り当て
  - 「Amazon の IPv4 アドレスプール」を選択
- 割り当てた IP アドレスを選択後、「Actions/Elastic IP アドレスの関連付け」を押下
- `インスタンス`は作成した EC2 インスタンスを選択
- `プライベートIP`は「10.0.10.10」を入力
- `パブリック IPv4 アドレス`の URL で Apache のデフォルトページが表示されることを確認

### Elastic IP アドレスと EC2 インスタンスを停止

- インスタンスに紐付いてない場合は課金されるので「Actions/アドレスの関連付けの解除」を押下。`アドレスの解放`を行う

| 画面                      |
| ------------------------- |
| サービス/EC2/インスタンス |

- 作成した EC2 インスタンスを選択
- 「アクション/インスタンスの状態/停止」を押下
