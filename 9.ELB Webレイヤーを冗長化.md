# 【ELB】Webレイヤーを冗長化

## 稼働率を上げるための基本的な考え方

- 障害発生間隔を長くする
- 平均復旧時間を短くする
- システムの構成要素を多重化する
- ある構成要素で障害が発生しても処理を引き継げるようにする
- 単一障害点(SPOF)をなくす

### 単一障害点とは

- 多重化してない構成要素
- ある構成要素で障害が発生するとシステム全体が停止する

## 稼働率を上げる具体的な方法

- 要素単体の稼働率を高くする(限界がある)
- 要素を組み合わせて、全体の稼働率を高くする(AWSで対応)
- 負荷を適切なプロビジョニングで回避する(AWSで対応)

### 要素を組み合わせて、全体の稼働率を高くする

冗長化構成

- Active-Active 冗長化した両方が利用可能
- Active-Standby 冗長化した片方は利用不可能
    - Hot Standby スタンバイ側は普段起動しすぐに利用可能
    - Warm Standby スタンバイ側は普段起動してるが、利用するのに準備が必要
    - Cold Standby スタンバイ側は普段停止している

### 負荷を適切なプロビジョニングで回避する

- プロビジョニングとはアクセス数を予測して適切にリソースを準備すること
- スケールアップさせる
    - 個々の要素の性能を向上させる
    - ある程度の規模まではスケールアップで対応。一定h範囲を超えるとコストパフォマンスが悪くなる
 - スケールアウトさせる
    - 個々の要素の数を増やす
    - ある程度の規模を超えそうであればスケールアウトで対応
    - 最低限用意しておくべき構成がN+1構成、安心なのはN+2構成。(Nは普段使用する要素数)

## ELBとは

- AWSクラウド上のロードバランサー
- ロードバランサーとは各サーバーにアクセスを振り分け、負荷を分散する装置
- 複数のEC2インタンスに負荷分散する
- 複数のアベイラビリティゾーンにある複数のEC2インタンスの中から正常なターゲットのみに分散する
- ヘルスチェックを元に障害が発生しているインタンスには分散させない

### ELBの特徴

- スケーラブル
    - ELB自体も負荷に応じて自動でスケールアウト、スケールインする
- アベイラビリティゾーンをまたがる構成
    - ELBを利用する場合、1つのリージョンを選択
    - そのリージョン内であればアベイラビリティゾーンをまたがる構成が可能
- DNS設定
    - ELBにはDNS名が割り当てられる
    - ELBへの接続ポイントのアクセスにはDNSを使用する
    - ELB自体のスケールアウト、スケールインにもDNSで対応
- 安価な従量課金
- マネージドサービス

## パブリックサブネットの作成

|  画面  |  押下  |
| ---- | ---- |
|  サービス/VPC/サブネット  |  サブネットの作成  |

- `名前タグ`を入力
- `VPC`は作成したVPCを選択
- `アベイラビリティーゾーン`を選択
- `IPv4 CIDR ブロック`で「10.0.11.0/24」を入力
- `作成`を押下

### インターネットゲートウェイに設定

- 作成したpublic-subnetを選択
- `ルートテーブル`の`ルートテーブルの関連付けの編集`を押下
- `ルートテーブル ID`で「public route」を選択

## AMIの作成

|  画面  |
| ---- |
|  サービス/EC2/インスタンス

- 作成済みのインスタンスを選択
- `アクション/イメージ/イメージの作成`を押下
- `イメージ名`と`イメージの説明`を入力
- 残りの項目はデフォルト値のまま`イメージの作成`を押下
- `イメージ/AMI`の画面で反映される

### AMIの設定と起動

|  画面  |
| ---- |
|  サービス/EC2/イメージ/AMI

- 作成したAMIを選択後、`起動`を押下
- インスタンスのタイプは`t2.micro`を選択
- `インスタンスの詳細の設定`を押下
- `ネットワーク`を作成したvpcを選択
- `サブネット`は追加したサブネットを選択
- `自動割り当てパブリック IP`を「有効」にする
- `キャパシティーの予約`は「なし」を選択
- `ネットワークインターフェイス`の`プライマリ IP`を「10.0.11.10」と入力
- `ストレージの追加`を押下
- `ストレージの追加`はデフォルト値のまま、`タグの追加`を押下
- `タグの追加`でキーと値を入力。例 Name: hoge.web
- `セキュリティグループの設定`を押下
- `セキュリティグループの設定`で`既存のセキュリティグループを選択する`でEC2インスタンスを選択
- `確認と作成`を押下、`起動`を押下
- キーペアの選択で既存のキーペアを選択してインスタンスを作成

