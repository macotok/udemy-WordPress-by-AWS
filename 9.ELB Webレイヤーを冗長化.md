# 【ELB】Webレイヤーを冗長化

## 稼働率を上げるための基本的な考え方

- 障害発生間隔を長くする
- 平均復旧時間を短くする
- システムの構成要素を多重化する
- ある構成要素で障害が発生しても処理を引き継げるようにする
- 単一障害点(SPOF)をなくす

### 単一障害点とは

- 多重化してない構成要素
- ある構成要素で障害が発生するとシステム全体が停止する

## 稼働率を上げる具体的な方法

- 要素単体の稼働率を高くする(限界がある)
- 要素を組み合わせて、全体の稼働率を高くする(AWSで対応)
- 負荷を適切なプロビジョニングで回避する(AWSで対応)

### 要素を組み合わせて、全体の稼働率を高くする

冗長化構成

- Active-Active 冗長化した両方が利用可能
- Active-Standby 冗長化した片方は利用不可能
    - Hot Standby スタンバイ側は普段起動しすぐに利用可能
    - Warm Standby スタンバイ側は普段起動してるが、利用するのに準備が必要
    - Cold Standby スタンバイ側は普段停止している

### 負荷を適切なプロビジョニングで回避する

- プロビジョニングとはアクセス数を予測して適切にリソースを準備すること
- スケールアップさせる
    - 個々の要素の性能を向上させる
    - ある程度の規模まではスケールアップで対応。一定h範囲を超えるとコストパフォマンスが悪くなる
 - スケールアウトさせる
    - 個々の要素の数を増やす
    - ある程度の規模を超えそうであればスケールアウトで対応
    - 最低限用意しておくべき構成がN+1構成、安心なのはN+2構成。(Nは普段使用する要素数)

## ELBとは

- AWSクラウド上のロードバランサー
- ロードバランサーとは各サーバーにアクセスを振り分け、負荷を分散する装置
- 複数のEC2インタンスに負荷分散する
- 複数のアベイラビリティゾーンにある複数のEC2インタンスの中から正常なターゲットのみに分散する
- ヘルスチェックを元に障害が発生しているインタンスには分散させない

### ELBの特徴

- スケーラブル
    - ELB自体も負荷に応じて自動でスケールアウト、スケールインする
- アベイラビリティゾーンをまたがる構成
    - ELBを利用する場合、1つのリージョンを選択
    - そのリージョン内であればアベイラビリティゾーンをまたがる構成が可能
- DNS設定
    - ELBにはDNS名が割り当てられる
    - ELBへの接続ポイントのアクセスにはDNSを使用する
    - ELB自体のスケールアウト、スケールインにもDNSで対応
- 安価な従量課金
- マネージドサービス

## パブリックサブネットの作成

|  画面  |  押下  |
| ---- | ---- |
|  サービス/VPC/サブネット  |  サブネットの作成  |

- `名前タグ`を入力
- `VPC`は作成したVPCを選択
- `アベイラビリティーゾーン`を選択
- `IPv4 CIDR ブロック`で「10.0.11.0/24」を入力
- `作成`を押下

### インターネットゲートウェイに設定

- 作成したpublic-subnetを選択
- `ルートテーブル`の`ルートテーブルの関連付けの編集`を押下
- `ルートテーブル ID`で「public route」を選択

## AMIの作成

|  画面  |
| ---- |
|  サービス/EC2/インスタンス

- 作成済みのインスタンスを選択
- `アクション/イメージ/イメージの作成`を押下
- `イメージ名`と`イメージの説明`を入力
- 残りの項目はデフォルト値のまま`イメージの作成`を押下
- `イメージ/AMI`の画面で反映される

### AMIの設定と起動

|  画面  |
| ---- |
|  サービス/EC2/イメージ/AMI

- 作成したAMIを選択後、`起動`を押下
- インスタンスのタイプは`t2.micro`を選択
- `インスタンスの詳細の設定`
    - `ネットワーク`を作成したvpcを選択
    - `サブネット`は追加したサブネットを選択
    - `自動割り当てパブリック IP`を「有効」にする
    - `キャパシティーの予約`は「なし」を選択
    - `ネットワークインターフェイス`の`プライマリ IP`を「10.0.11.10」と入力
- `ストレージの追加`
    - デフォルト値のまま
- `タグの追加`
    キーと値を入力。例 Name: hoge.web
- `セキュリティグループの設定`
    `既存のセキュリティグループを選択する`でEC2インスタンスを選択
- `起動`を押下
- キーペアの選択で既存のキーペアを選択してインスタンスを作成

## ELBの作成

|  画面  |  押下  |
| ---- | ---- |
|  サービス/EC2/ロードバランサー | ロードバランサーの作成

- `ロードバランサーの種類の選択`で「Application Load Balancer」を選択
    - `Application Load Balancer`はクライアントからリクエストがあった場合、クライアント→Application Load Balancer
→Webサーバーの経路を辿る。レスポンスはWebサーバー→Application Load Balancer→クライアントの経路を辿る。
    - `Network Load Balancer`はクライアントからリクエストがあった場合、クライアント→Network Load Balancer
→Webサーバーの経路を辿る。レスポンスはWebサーバー→クライアントの経路を辿る。
    - `Network Load Balancer`の方が非常に高いパフォーマンスが得られる。
- ロードバランサーの設定
    - `名前`を入力
    - `スキーム`はインターネット通信によるロードバランサーなので「インターネット向け」を選択
    - `IP アドレスタイプ`は「ipv4」を選択
    - `アベイラビリティーゾーン`
        - `VPC`は作成したVPCを選択
        - `アベイラビリティーゾーン`は「ap-northeast-1a」「ap-northeast-1c」で作成したpublic subnetを選択
- セキュリティ設定の構成
    設定なし
- セキュリティグループの設定
    - `セキュリティグループの割り当て`で「新しいセキュリティグループを作成する」を選択
    - `セキュリティグループ名`と`説明`を入力
    - `タイプ`は「HTTP」を選択
    - `プロトコル`は「TCP」を選択
    - `ポート範囲`は「80」を入力
    - `ソース`は「カスタム　0.0.0.0/0, ::/0」を入力
- ルーティングの設定
    - `ターゲットグループ`は「新しいターゲットグループ」を選択
    - `名前`を入力
    - `ターゲットの種類`はEC2インタンスをターゲットにするため「インタンス」を選択
    - `プロトコル`は「HTTP」を選択
    - `ポート`は「80」を入力
    - `ヘルスチェック`のパスはアプリケーションのパスを入力「/」と入力
    - `ヘルスチェックの詳細設定`でロードバランサーの確認のため敢えて`正常のしきい値`を「2」。`間隔`を「10」に設定
- ターゲットの登録
    - 作成したインタンスを選択後、`登録済みに追加`を押下後、`登録済みターゲット`に反映
- 作成したELBの`DNS 名`のURLでWordPressのTopページが表示されることを確認


## ELBのDNSをRoute53に設定

|  画面  |  押下  |
| ---- | ---- |
|  サービス/Route53/ホストゾーン | 独自ドメイン

- 独自ドメインの`Aレコード`を選択。(値のアドレスはEC2のIPV4)
- `エイリアス`を「はい」
- `エイリアス先`を作成したロードバランサーを選択
- `レコードセットの保存`を押下

## ヘルスチェック確認

- Webサーバーにログイン
- Apacheを停止する

```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
[ec2-user@ip-10-0-10-10 ~]$ sudo systemctl stop httpd.service
```

|  画面  |
| ---- |
|  サービス/EC2/ロードバランシング/ターゲットグループ

- 作成したターゲットを選択後、`ターゲット`のタブを選択
- Apacheで停止したインタンスの`ステータス`が「unhealthy」になってることを確認

## ELBを運用する際のポイント

- サーバーをアベイラビリティゾーンをまたがって配置する
    - 1つのアベイラビリティゾーンで災害や事故があったときにも対応するため
- Webサーバーをステートレスに構築する
    - WebサーバーにDBサーバー、ファイルサーバーなどの別のサーバーを置かない
