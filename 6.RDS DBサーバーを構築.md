# 【RDS】DBサーバーを構築

## RDSとは

- AWSのフルマネージド、リレーショナルデータベースのサービス
- コア機能の開発に注力できるように設計されている
- EC2にDBを設置する場合に提供されるAWSサービス
  - OSインストール
  - 物理サーバー設置
- RDSにDBを設置する場合に提供されるAWSサービス
  - OSインストール
  - 物理サーバー設置
  - スケーリング
  - バックアップ
  - アップデート

### RDSの利用可能なエンジン

- MySQL
- PostgreSQL
- Oracle
- Microsoft SQL Server
- Amazon Aurora
- MariaDB

### 各種設定グループ

- DBパラメータグループ(DB設定値を制御)
- DBオプショングループ(RDSへの機能追加を制御)
- DBサブネットグループ(RDSを起動させるサブネットを制御)

## RDSの特徴

- 可用性の向上
- パフォーマンスの向上
- 運用負荷の軽減

### 可用性の向上

- マルチAZを簡単に構築
  - 複数のアベイラビリティゾーンをまたいでRDSインスタンスを作成
  - 作成するRDSの1つはマスター、もう1つはスレーブ
  - 通常はマスターを使用、マスターが壊れたらスレーブに接続

### パフォーマンスの向上

- リードレプリカを簡単に構築
  - マスターと同期された読み取り専用のRDSをリードレプリカ
  - アプリクーポンからのDBの読み込みはリードレプリカで行う

### 運用負荷の軽減

- 自動的なバックアップ
  - 1日1回バックアップを自動取得(スナップショット)
  - スナップショットを元にDBインスタンスを作成(リストア)
- 自動的なソフトウェアメンテナンス
  - メンテナンスウィンドウで指定した曜日・時間帯にアップデートを自動実施
- 監視
  - 各種メトリクスを60秒間隔で取得・確認可能

## プライベートサブネットを作成

- マルチAZを構築するために複数のアベイラビリティゾーンでプライベートサブネットを作成する
- すでに１つプライベートサブネット(10.0.20.0/24)を作成しているのでもう1つプライベートサブネットを作成する
- IPアドレスは`10.0.21.0/24`

|  画面  |  押下  |
| ---- | ---- |
|  サービス/VPC/サブネット  |  サブネットの作成  |

- VPCは作成済のVPCを選択
- アベイラビリティゾーンは`ap-northeast-1c`を選択
- IPv4 CIDR ブロックは`10.0.21.0/24`と入力

## RDSの作成準備

1. セキュリティグループの作成
2. DBサブネットグループの作成
3. DBパラメータグループの作成
4. DBオプショングループの作成

### セキュリティグループの作成

|  画面  |  押下  |
| ---- | ---- |
|  サービス/EC2/セキュリティグループ  |  セキュリティグループの作成  |

- VPCは作成したVPCを選択
- インバウンドで`ルールの追加`
- タイプは`MySQL/Aurora`
- プロトコルは`TCP`。ポート番号は`3306`
- ソースは`カスタム`選択後、作成したwebサーバーを選択

### DBサブネットグループの作成

- サブネットグループでマルチAZを構成。VPC内のサブネットを複数選択

|  画面  |  押下  |
| ---- | ---- |
|  サービス/RDS/サブネットグループ  |  DB サブネットグループの作成  |

- VPCは作成したVPCを選択
- サブネットの追加では作成した2つのプライベートサブネットを選択する
- 1つ目のアベイラビリティゾーンは`ap-northeast-1a`
- 1つ目のサブネットはプライベートサブネットの`10.0.20.0/24`
- 2つ目のアベイラビリティゾーンは`ap-northeast-1c`
- 2つ目のサブネットはプライベートサブネットの`10.0.21.0/24`

### DBパラメータグループの作成

- DBパラメータグループとはRDSでDBの設定ファイルを直接触れないので設定値をDBパラメータグループで行う

|  画面  |  押下  |
| ---- | ---- |
|  サービス/RDS/パラメーターグループ  |  パラメーターグループの作成  |

- パラメータグループファミリーは`mysql8.0`を選択
- グループ名と説明は同じで良い
- 作成したパラメーターグループを選択して`パラメーターグループアクション/編集`で各設定値を変更できる
- 変更可能でtrueとfalseがある
- 適用タイプでdynamicとstaticがある
   - dynamicはRDSの設置は動的に反映される
   - staticはRDSの設定後に反映される

### DBオプショングループの作成

- DBオプショングループとはDBの機能的部分を扱う。プラグインを使いたいときなど

|  画面  |  押下  |
| ---- | ---- |
|  サービス/RDS/オプショングループ  |  オプショングループの作成  |

- 名前と説明は同じで良い
- エンジンは`mysql`を選択
- メジャーエンジンのバージョンは`8.0`を選択
- オプショングループを作成するとデフォルトのオプショングループが作成されるが自身が作成したオプショングループを使用。オプショングループの値を変更するときに使用するため

## RDSの作成

|  画面  |  押下  |
| ---- | ---- |
|  サービス/RDS/データベース  |  データベースの作成  |

- 本番環境ではRDSインスタンスを停止しないほうが良い。停止するのに時間かかる、RDSのリソースが余ってないと起動できないため

### エンジンのオプション

- エンジンのタイプは`MySQL`を選択
- バージョンは`MySQL8.0.15`を選択

### テンプレートは

- `開発/テスト`を選択
- `本番稼働用`は料金がかかる
- `無料利用枠`は設定できる項目に限度あり

### 設定

- DBインスタン識別子はwebサーバーの名前
- 認証情報の設定
   - マスターユーザー名は`root`
   - パスワードを入力

### DBインスタンスサイズ

- 通常は`標準クラス`を選択
- 学習用の場合、料金を抑えるため`バースト可能クラス`を選択

### ストレージ

- ストレージタイプは`汎用(SSD)`を選択
- ストレージの割り当ては`20GiB`
- `ストレージの自動スケーリング`はDBへの負荷が上がるとオートスケールするかどうか。`無効`にする

### 可用性と耐久性

- マルチAZを作成すると料金がかかるので学習用の場合は`スタンバイインスタンスを作成しないでください`を選択

### 接続

- Virtual Private Cloud (VPC)は作成したVPCを選択
- 追加の接続設定を選択
  - サブネットグループで作成したサブネットグループを選択
  - パブリックアクセス可能はVPCの外からアクセス可能かを選択。DBをVPC内のwebサーバーからのアクセスのみにしたいので`なし`を選択
  - VPCセキュリティグループは`既存の選択`を選択
  - 既存のVPCセキュリティグループは作成したセキュリティグループを選択。`default`は選択解除
  - アベイラビリティゾーンは`ap-northeast-1a`を選択
  - データベースポートは`3306`を選択

### 追加設定

- 最初のデータベース名はRDSインスタンスを作成後に作成
- DB パラメータグループは作成したパラメーターグループを選択
- オプショングループは作成したオプショングループを選択
- IAM db認証はチェックなし
- バックアップ
   - `自動バックアップの有効化`をチェック
   - バックアップ保持期間は`30日間`を選択
   - バックアップウィンドウで時間を指定
   - スナップショットにタグをコピーにチェック
   - 手動でスナップショットを取得した場合、保持期間を超えたりRDSインスタンスを削除しても残る
- モニタリング
   - `拡張モニタリングの有効化`はチェックしない。有効化すると料金がかかる
- ログのエクスポートは全てチェックなし
- メンテナンス
   - `マイナーバージョン自動アップグレードの有効化`にチェック
   - メンテナンスウィンドウでメンテナンス時間を指定
- 削除保護
   - DBを削除できないようにするか

## WebサーバーからRDSに接続

- WebサーバーにMySQLをインストール
- WebサーバーからRDSへmysqlコマンドで接続

### サーバーに接続

sshにログイン
```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```

MySQLをインストール
```terminal
$ sudo yum -y install mysql
```

MySQLコマンドでRDSへ接続
```terminal
$ mysql -h {エンドポイント} -u {マスターユーザー名} -p
```
- `RDS/データベース`で作成したデータベースの`エンドポイント`をコピー
