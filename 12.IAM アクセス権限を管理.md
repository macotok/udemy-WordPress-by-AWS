# 【IAM】アクセス権限を管理

## IAM とは

- AWS のサービスを利用するユーザー権限を管理するサービス
- AWS リソースをセキュアに操作するために認証・認可の仕組みを提供する
- 各 AWS リソースに対して別々のアクセス権限をユーザーごとに付与できる
- IAM 自体の利用は無料
- ポリシー
  - アクセス許可の定義
  - 「どの AWS のサービスの」「どのリソースに対して」「どんな操作を」「許可する、または許可しない」を定義
  - ポリシーを「ユーザー」「グループ」「ロール」に割り当てる
- ユーザー
  - 個々のアカウントのユーザー
  - 1 つのアカウントを使い回すのではなく、個々にアカウントを作成する
- グループ
  - IAM ユーザーの集合体
  - 複数のユーザーにアクセス許可を付与する作業を簡素化
  - グループでアクセス権限を付与するとそのグループに属するユーザーに反映される
- ロール
  - 一時的にアクセスを許可したアカウントを発行できる
  - アクセスするためのアクセスキーとシークレットキーが一時的に付与される。アクセスすると削除されるので漏洩のリスクなし
  - EC2 や Lambda などの AWS リソースに権限を付与するために使用

## AWS Organizations とは

- IAM のアクセス管理を大きな組織でも楽に実施できる
- マスターアカウントがメンバーアカウントを管理する仕組み
  - 複数アカウントの一元管理
  - 新規アカウント作成の自動化
  - 一括請求

## IAM ポリシーを作成

| 画面                    | 押下           |
| ----------------------- | -------------- |
| サービス/IAM/ポリシー　 | ポリシーの作成 |

- DevveloperPolicy と DirecotorPolicy を作成する

### DevveloperPolicy の作成

- `サービス`に「EC2」を選択
- `アクション`で「すべての EC2 アクション」を選択
- `リソース`は「すべてのリソース」を選択
- `サービス`に「RDS」を選択
- `アクション`で「すべての RDS アクション」を選択
- `リソース`は「すべてのリソース」を選択
- ポリシーの確認
  - `名前`を入力
  - `説明`を入力

### DirecotorPolicy の作成

- `サービス`に「EC2」を選択
- `アクション`で「読み込み」を選択
- `リソース`は「すべてのリソース」を選択
- ポリシーの確認
  - `名前`を入力
  - `説明`を入力

## IAM グループの作成

| 画面                    | 押下           |
| ----------------------- | -------------- |
| サービス/IAM/グループ　 | グループの作成 |

- グループ名の設定
  - `グループ名`を入力
  - `ポリシータイプ`で作成した「ポリシー」を選択

## IAM ユーザーの作成

| 画面                    | 押下           |
| ----------------------- | -------------- |
| サービス/IAM/ユーザー　 | ユーザーを追加 |

- ユーザーを追加
  - `ユーザー名`でグループに属するユーザー名を入力
  - `別のユーザーの追加`を押下で複数人登録可能
  - AWS アクセスの種類を選択
    - `アクセスの種類`で「AWS マネジメントコンソールへのアクセス」を選択
    - `コンソールのパスワード`は通常「自動生成パスワード」を選択
- ユーザーをグループに追加
  - 所属させたいグループを選択
- タグの追加 (オプション)
  - 入力なし

## IAM ロールの作成

- ロールの作成で EC2 から S3 のバケット一覧を取得する
- 通常は権限がないと S3 のバケット一覧は取得できない

SSH ログイン

```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```

S3 のバケット一覧を取得するコマンド

```terminal
[ec2-user@ip-10-0-10-10 ~]$ aws s3 ls
```

権限がないというメッセージが表示される

```terminal
Unable to locate credentials. You can configure credentials by running "aws configure".
```

| 画面                  | 押下         |
| --------------------- | ------------ |
| サービス/IAM/ロール　 | ロールの作成 |

- ロールの作成
  - `ユースケースの選択`で「EC2」を選択
- Attach アクセス権限ポリシー
  - 「AmazonS3FullAccess」を選択
- タグの追加 (オプション)
  - 入力なし
- 確認
  - `ロール名`を入力

### EC2 インスタンスをアタッチ

| 画面                        | 選択                   |
| --------------------------- | ---------------------- |
| サービス/EC2/インスタンス　 | 作成済みのインスタンス |

- `アクション/インスタンスの設定/IAMロールの割り当て/置換`を選択
- IAM ロールの割り当て/置換
  - `IAM ロール`で作成したロールを選択

S3 のバケット一覧を取得できる

```terminal
[ec2-user@ip-10-0-10-10 ~]$ aws s3 ls
```

## IAM のベストプラクティス

- 個々人に IAM ユーザーを作成する
  - ルートユーザーでアクセスしないようにする
  - 1 つのアカウントを複数で使い回さないようにする
- ユーザーをグループに所属させ、グループに権限を割り当てる
  - ユーザーごとに権限を割り当てると変更のときに面倒
- 権限を最小限にする
  - 必要に応じて都度権限を付与する
- EC2 インスタンスから実行するアプリケーションにはロールを使用する
  - EC2 から別のサービスにアクセスするには認証情報が必要
  - 認証情報にはアクセスキーやシークレットキーが必要
- 定期的に不要な認証情報は削除する
  - 使用してない IAM ユーザーは削除する
