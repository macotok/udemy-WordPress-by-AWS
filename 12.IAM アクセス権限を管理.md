# 【IAM】アクセス権限を管理

## IAMとは

- AWSのサービスを利用するユーザー権限を管理するサービス
- AWSリソースをセキュアに操作するために認証・認可の仕組みを提供する
- 各AWSリソースに対して別々のアクセス権限をユーザーごとに付与できる
- IAM自体の利用は無料
- ポリシー
    - アクセス許可の定義
    - 「どのAWSのサービスの」「どのリソースに対して」「どんな操作を」「許可する、または許可しない」を定義
    - ポリシーを「ユーザー」「グループ」「ロール」に割り当てる
- ユーザー
    - 個々のアカウントのユーザー
    - 1つのアカウントを使い回すのではなく、個々にアカウントを作成する
- グループ
    - IAMユーザーの集合体
    - 複数のユーザーにアクセス許可を付与する作業を簡素化
    - グループでアクセス権限を付与するとそのグループに属するユーザーに反映される
 - ロール
    - 一時的にアクセスを許可したアカウントを発行できる
    - アクセスするためのアクセスキーとシークレットキーが一時的に付与される。アクセスすると削除されるので漏洩のリスクなし
    - EC2やLambdaなどのAWSリソースに権限を付与するために使用

## IAMポリシーを作成

|  画面  |  押下 |
| ---- | ---- |
|  サービス/IAM/ポリシー　|  ポリシーの作成 |

- DevveloperPolicyとDirecotorPolicyを作成する

### DevveloperPolicyの作成
- `サービス`に「EC2」を選択
- `アクション`で「すべての EC2 アクション」を選択
- `リソース`は「すべてのリソース」を選択
- `サービス`に「RDS」を選択
- `アクション`で「すべての RDS アクション」を選択
- `リソース`は「すべてのリソース」を選択
- ポリシーの確認
    - `名前`を入力
    - `説明`を入力

### DirecotorPolicyの作成

- `サービス`に「EC2」を選択
- `アクション`で「読み込み」を選択
- `リソース`は「すべてのリソース」を選択
- ポリシーの確認
    - `名前`を入力
    - `説明`を入力

## IAMグループの作成

|  画面  |  押下 |
| ---- | ---- |
|  サービス/IAM/グループ　|  グループの作成 |

- グループ名の設定
    - `グループ名`を入力
    - `ポリシータイプ`で作成した「ポリシー」を選択

## IAMユーザーの作成

|  画面  |  押下 |
| ---- | ---- |
|  サービス/IAM/ユーザー　|  ユーザーの作成 |

- ユーザーを追加
    - `ユーザー名`でグループに属するユーザー名を入力
    - `別のユーザーの追加`を押下で複数人登録可能
    - `AWS アクセスの種類を選択`
        - `アクセスの種類`で「AWS マネジメントコンソールへのアクセス」を選択
        - `コンソールのパスワード`は通常は「自動生成パスワード」を選択
- ユーザーをグループに追加
    - 所属させたいグループを選択
- タグの追加 (オプション)
    - 入力なし

## IAMロールの作成

- ロールの作成でEC2からS3のバケット一覧を取得する
- 通常は権限がないとS3のバケット一覧は取得できない

```terminal
// SSHにログイン
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}

// S3のバケット一覧を取得するコマンド
[ec2-user@ip-10-0-10-10 ~]$ aws s3 ls

// 権限がないというメッセージが表示される
Unable to locate credentials. You can configure credentials by running "aws configure".
```

|  画面  |  押下 |
| ---- | ---- |
|  サービス/IAM/ロール　|  ロールの作成 |

- ロールの作成
    - `ユースケースの選択`で「EC2」を選択
 - Attach アクセス権限ポリシー
    - 「AmazonS3FullAccess」を選択
 - タグの追加 (オプション)
    - 入力なし
 - 確認
    - `ロール名`を入力
    
### EC2インスタンスをアタッチ

|  画面  |  選択 |
| ---- | ---- |
|  サービス/EC2/インスタンス　|  作成済みのインスタンス |

- `アクション/インスタンスの設定/IAMロールの割り当て/置換`を選択
- IAM ロールの割り当て/置換
    - `IAM ロール`で作成したロールを選択

S3のバケット一覧を取得できる
```terminal
[ec2-user@ip-10-0-10-10 ~]$ aws s3 ls
```

## IAMのベストプラクティス

- 個々人にIAMユーザーを作成する
    - ルートユーザーでアクセスしないようにする
    - 1つのアカウントを複数人で使い回さないようにする
- ユーザーをグループに所属させ、グループに権限を割り当てる
    - ユーザーごとに権限を割り当てると変更のときに面倒
- 権限を最小限にする
    - 必要に応じて都度権限を付与する
- EC2インスタンスから実行するアプリケーションにはロールを使用する
    - EC2から別のサービスにアクセスするには認証情報が必要になる
    - 認証情報にはアクセスキーやシークレットキーが必要なので漏洩の危険がある
- 定期的に不要な認証情報は削除する
    - 使用してないIAMユーザーは削除する
