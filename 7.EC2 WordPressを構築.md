# 【EC2】WordPressを構築

- WebサーバーにWordPressをインストール
- WordPressからデータベースを接続

## WordPress用のデータベースを作成

1. データベース作成
2. ユーザー作成
3. ユーザーに権限付与

### データベース作成

SSHにログイン
```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```

MySQLコマンドでRDSへ接続
```terminal
$ mysql -h {エンドポイント} -u {マスターユーザー名} -p
```
- `RDS/データベース`で作成したデータベースの`エンドポイント`をコピー

データベース作成
```terminal
MySQL [(none)]> CREATE DATABASE {データベース名} DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
```
- `CREATE DATABASE`はデータベースを作成するコマンド
- `DEFAULT CHARACTER SET`でデフォルトの文字コード指定
- `COLLATE`は比較に対するデフォルト照合順序

データベースが作成されたか確認
```terminal
MySQL [(none)]> SHOW DATABASES;
```

WordPress用のユーザー作成
```terminal
MySQL [(none)]> CREATE USER '{ユーザー名}'@'%' IDENTIFIED BY '{パスワード}';
```
- `'@'%'`で接続元はどこでもOK
- `IDENTIFIED BY`でパスワードを指定

作成したユーザーに権限付与
```terminal
MySQL [(none)]> GRANT ALL ON {データベース名}.* TO '{ユーザー名}'@'%';
```
- `GRANT`コマンドで権限付与
- `ALL`で全ての操作権限を付与
- `{データベース名}.*`でデータベースの全てのテーブルを操作できる

設定を反映させる
```terminal
MySQL [(none)]> FLUSH PRIVILEGES;
```

ユーザー作成が反映されたか確認
```terminal
MySQL [(none)]> SELECT user , host FROM mysql.user;
```

作成したユーザーでMySQLに接続できるか確認
```terminal
$ mysql -h {エンドポイント} -u {作成したユーザー名} -p
```

## WordPressのインストール

1. ライブラリのインストール
2. WordPressのダウンロード
3. WordPressの解凍
4. WordPressのプログラムをApacheから見える場所に配置(/var/www/html)
5. WordPressファイルの所有者をApacheに変更
6. Apacheの再起動

### ライブラリのインストール

SSHにログイン
```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```

`amazon-linux-extras`からphp7.2をinstall
```terminal
$ sudo amazon-linux-extras install -y php7.2
```

php7.2に対応したライブラリのインストール
```terminal
$ sudo yum install -y php php-mbstring
```

### WordPressのダウンロード

homeディレクトリでダウンロード
```terminal
$ cd ~
$ wget https://ja.wordpress.org/latest-ja.tar.gz
```
- `wget`コマンドはURLを指定してファイルをダウンロードする

### WordPressの解凍

```terminal
$ tar xzvf latest-ja.tar.gz
```
- `tar`は複数のファイルを圧縮したり解凍するコマンド
- `xzvf`でgzファイルを解凍する

### WordPressのプログラムをApacheから見える場所に配置(/var/www/html)

```terminal
$ cd wordpress/
$ sudo cp -r * /var/www/html/
```

- `/var/www/html`はApacheが参照しているディレクトリ
- ブラウザからアクセスがあるとそのディレクトリに配置されているファイルを読む
- `-r *`でカレントディレクトリの全てのディレクト/ファイルを対象にする

### WordPressファイルの所有者をApacheに変更

```terminal
$ sudo chown apache:apache /var/www/html/ -R
```
- `chown`コマンドでWordPressの所有者を変更
- `apache:apache`で所有者をApacheに変更
- `-R`は指定したファイル以下全てが対象

### Apacheの再起動

Apacheの起動状態を確認
```terminal
$ sudo systemctl status httpd.service
```
- `Active: active (running)`で起動中

Apacheの起動コマンド
```terminal
$ sudo systemctl start httpd.service
```

Apacheの再起動コマンド
```terminal
$ sudo systemctl restart httpd.service
```

## WordPressの設定

- データベース名、ユーザー名、パスワードはMySQLで作成したDATABASEを使用
- データベースのホスト名は`RDS/データベース/作成したデータベース名のエンドポイント`を指定
- テーブル接頭辞は`wp_`のまま

## WordPressのサイトが表示される流れ

1. Webブラウザで`www.example.com`にアクセスする
2. Route53に`www.example.com`のIPアドレスを問い合わせる
3. Route53がWebブラウザにIPアドレス`http://12.345.67.890`を教える
4. Webサーバーに`http://12.345.67.890`でアクセスする
5. WordPressがDBサーバーにDBを参照する
6. DBサーバーがDBの値を返す
7. Webページを返す

## TCP/IPとは

- インターネットを構築するする上で必要なプロトコル群の総称
- インターネットではTCP/IPに基づいて通信が行われている

### プロトコルとは

- コンピューター同士がネットワークを利用して通信するために決められた約束ごと
- メーカーやOSが違うコンピューター同士が通信するためには同じ仕様でやり取りする必要がある
- 同じプロトコルを使用することで様々なコンピューター同士が通信できる

#### プロトコルの例

- HTTP
- TCP
- UDP
- IP
- SMTP
- IPX

### TCP/IPの階層モデル

- インターネットでコンピューター同士が通信する一連の処理を4階層で表現
- 通信に必要な機能全体を整理
- アプリケーション層
   - データを入力して送信
   - 文字コードの処理
   - アプリケーション同士が会話する
   - HTTP、DNS、SSH、SMTPなどのプロトコル
- トランスポート層
   - アプリケーション間の通信の実現(コネクションの確立・切断)
   - 必要に応じて再送処理を行う
   - データの転送を制御する
   - TCP、UDPなどのプロトコル
- ネットワーク層
   - ネットワークが接続された環境でIPアドレス宛にパケットを届ける
   - IPアドレスを管理し経路選択する
   - IP、ICMP、ARPなどのプロトコル
- ネットワークインターフェース層
   - 物理アドレス宛に信号を送信する
   - NIC(LANを使うための部品)を動かすためのデバイスドライバ
   - 直接接続された機器同士で通信する
   - Ethernet、PPPなどのプロトコル

## HTTPプロトコルについて

- WebブラウザとWebサーバー間が通信する時に利用されるプロトコル
- アプリケーション層のプロトコル

### HTTPとは

- HyperText Transfer Protocolの略
- インターネットでHTMLなどのコンテンツの送受信に用いられる通信の約束ごと
- クライアントがHTTPリクエストを送り、それに対してサーバーがHTTPレスポンスを返す。そのリクエスト・レスポンスの書き方がHTTPの正体

### HTTPリクエストの中身

- リクエストライン、ヘッダー、ボディから構成される
- リクエストライン
   - GET / HTTP/1.1
   - メソッド、リクエスト先のURI、HTTPのversionで構成される
- ヘッダー
   - Host: example.com
   - User-Agent: Mozilla/5.0
   - Accept-Encoding: gzip, deflate
   - Connection: keep-alive
- ボディ
   - 特になし

### HTTPレスポンスの中身

- ステータスライン、ヘッダー、ボディから構成される
- ステータスライン
   - HTTP/1.1 200 OK
   - HTTPのversion、ステータスコード、ステータスコードのテキスト
- ヘッダー
   - Date: Fri, 28 Jun 2019 01:09:23 GMT
   - Content-Type: text/html; charset=UTF-8
   - Cache-Control: max-age=604800
   - Last-Modified: Fri, 09 Aug 2013 23:54:35 GMT
- ボディ
   - HTMLのソースコード
