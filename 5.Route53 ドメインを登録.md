# Route53 ドメインを登録しよう

## ドメインとは

- インターネット上に存在するコンピューターやネットワークを識別するための名前
- IPアドレスは数字の列なので人にとっては覚えにくい
- ドメイン名を用いてWebサイトにアクセスできるようにする
- ピリオドで区切られた構造

### ドメインの構造

- www.example.co.jpの場合
  - www 第４レベルドメイン
  - example 第3レベルドメイン
  - co 第2レベルドメイン
  - jp トップレベルドメイン

### ドメインを管理している組織

- ICANN
  - ドメイン全体を管理
  - IPアドレスも管理
- レジストリ
  - 各トップレベルドメインを管理
  - レジストラに卸す
- レジストラ
  - リセラに卸す
  - 一般消費者に販売
  - ドメインの登録事業者
    - 「お名前.com」「ゴンベエドメイン」
    - 「お名前.com」は国内最大のレジストラ。580種類以上のドメインを取り扱い
  - レジストラの方がリセラより安い
- リセラ
  - 一般消費者に販売
  - ドメインの再販事業者
    - 「Yahoo!ドメイン」「ムームードメイン」「VALUE-DOMAIN」

## DNSとは

 - Webサイトで見るにはドメインとサーバー(IPアドレス)をDNSで紐付ける
 - ドメイン名をIPアドレスに変換する
 - ネームサーバーとフルリゾルバの2つから構成

### ネームサーバーとは

 - ドメイン名とそれに紐づくIPアドレスが登録されているサーバー
 - 電話帳をイメージ
 - ドメインの階層ごとにネームサーバーが配置。そのネームサーバーが配置された階層のドメイン情報を管理


### フルリゾルバとは

 - どのドメインに紐づくIPアドレスかをネームサーバーからIPアドレスを調べるサーバー
 - 秘書をイメージ
 - キャッシュするので毎回ネームサーバーに問い合わせる必要なし

 ### Webページが表示されるまでのDNSの仕組み

 1. WebブラウザにURLを入力
 2. フルリゾルバにURLのIPアドレスをリクエスト
 3. フルリゾルバがルートネームサーバーに問い合わせる
 4. トップレベルドメインを管理しているネームサーバーに問い合わせる
 5. ドメインを管理しているネームサーバーにIPアドレスを問い合わせる
 6. フルリゾルバがIPアドレスを取得
 7. WebブラウザにIPアドレスを返す
 8. WebブラウザがWebサーバーに接続

 ### リソースレコードとは

 - DNSのドメイン名とIPアドレスの紐付けの一つ一つのことをリソースレコードと呼ぶ
 - DNSはIPアドレス以外も管理

 ### リソースレコードのタイプ

 - Aレコード
   - ドメインに紐づくIPアドレス
 - NSレコード
   - ドメインのゾーンを管理するネームサーバー
 - MXレコード
   - ドメインに紐づくメール受信サーバー
 - CNAME
   - ドメインの別名でリソースレコードの参照先
 - SOA
   - ドメインのゾーンの管理情報

## ドメインを購入

- 1年目と2年目以降のドメイン価格が異なる
- Whois情報とは持ち主の名前や住所、連絡先を公開しなければならないこと
- Whois情報を登録するとレジストリで管理。インターネット上で公開される
- Whois情報公開代行はドメイン購入先が代わりに行うこと

## Route53とは

- AWSのDNSサービス
- ネームサーバーの役割を果たす

### Route53の特徴

- 高可用性(システムが継続して稼働できる)
- SLA100%(稼働率100%)
- 高速
    - エッジロケーションの中で最も近いロケーションから応答を返す
- フルマネージドサービス(障害監視などAWSが全て行う)
    - DNSサーバーの設計/構築/維持管理が不要

### Route53の重要概念

- ホストゾーン
    - DNSのリソースレコードの集合。ゾーンファイルのようなもの
- レコードセット
    - リソースレコードのこと
- ルーティングポリシー
    - レコードセットに対してどのようにルーティングを行うかをRoute53が決める
- ヘルスチェック
    - サーバの稼働状況をチェック

### ルーティングポリシーとは

- シンブル
  - ドメインへの問い合わせに対してレコードセットで事前に設定された値に基づいて応答
  - 最初はこちらを使用することが多い
- 加重
  - ドメインへの問い合わせに対して複数エンドポイントごとに設定された重み付けに基づいて応答
  - 提供リソースに差がある場合やABテスト時に使用
- レイテンシー
  - リージョン間の遅延が少ない方のリソースへルーティングする
  - マルチリージョンにリソースが存在する場合に使用
- 位置情報
  - ドメインへの問い合わせに対してクライアントの位置情報に基づいて応答
  - コンテンツのローカライズや地域限定配信時に使用
- フェイルオーバー
  - ヘルスチェックの結果に基づいて利用可能なリソースへルーティングする
  - 障害発生時にSorryサーバーに簡単に切り替えられる

## Route53でDNSを設定

構築するもの

1. WebブラウザにURLを入力
2. フルリゾルバにURLのIPアドレスをリクエスト
3. フルリゾルバがルートネームサーバーに問い合わせる
4. トップレベルドメインを管理しているネームサーバーに問い合わせる
5. ドメインを管理しているRoute53ネームサーバーにIPアドレスを問い合わせる
6. フルリゾルバがIPアドレスを取得
7. WebブラウザにIPアドレスを返す
8. WebブラウザがWebサーバーに接続

- 「4」をRoute53のネームサーバーで行う
- ドメインのネームサーバーをRoute53に変更
  - Route53でホストゾーンを作成
  - ネームサーバーをお名前.comからRoute53に変更
- ドメインに紐づくIPアドレスを登録
  - Route53でレコードセットを作成
  - ドメインに紐づくIPアドレスを登録

### ホストゾーンを作成

|  画面  |  押下  |
| ---- | ---- |
|  サービス/Route53/ホストゾーン  |  ホストゾーンの作成  |

- `ドメイン名`は購入したドメインを入力
- `タイプ`は「パブリックホストゾーン」を選択。インターネットからアクセス時使用のため

### ネームサーバーを確認

- EC2インスタンスを稼働してElastic IPを関連付ける

SSHログイン
```terminal
$ ssh -i {秘密鍵}.pem ec2-user@{IPv4パブリックIP}
```

ネームサーバーを確認
```terminal
$ dig {ドメイン名} NS +short
```
- `dig`コマンドはドメインやIPアドレスに紐づくものを調べる
- `dig`コマンドでネームサーバーのみを知りたいときは`+short`
- お名前.comのネームサーバーが表示される。これはトップレベルドメインを管理しているネームサーバーに問い合わせた結果
- お名前.comでRoute53のネームサーバーを設定

### お名前.comでRoute53のネームサーバーを設定

- Route53のホストゾーン作成で取得したNSタイプのネームサーバーをお名前.comのネームサーバーに設定
- 4つのネームサーバーを設定

## ドメイン名にEC2インスタンスのIPアドレスを紐付ける

|  画面  |  押下  |
| ---- | ---- |
|  サービス/Route53/ホストゾーン  |  レコードセットの作成  |

- Route53でAレコードを登録
- `タイプ`は「A」を選択
- `TTL (秒)`はフルリゾルバにIPアドレスとドメインの紐付けをキャッシュする秒数
- `値`にEC2インスタンスの「IPv4パブリックIP」を入力
- Route53のネームサーバーに設定変更されたかを確認
