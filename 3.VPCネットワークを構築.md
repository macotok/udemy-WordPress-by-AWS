# VPC ネットワークを構築

## リージョンとは

- AWS の各サービスが提供されている地域のこと
- リージョンによって使えるサービスが異なる
- 最新機能はアメリカのリージョンで使える
- 日本の場合は東京リージョンを選択

## アベイラビリティゾーンとは

- AWS は各国にデータセンターをもっている
- 複数のデータセンターを束ねたものがアベイラビリティゾーン
- リージョンには２つ以上のアベイラビリティゾーンが物理的に離れて存在する
- 複数存在する理由は、災害があって特定のアベイラビリティゾーンが利用できない場合、他のアベイラビリティゾーンを利用するため
- 東京には 3 つのアベイラビリティゾーンが存在する
  - ap-northeast-1a
  - ap-northeast-1c
  - ap-northeast-1d

## エッジロケーションとは

- キャッシュデータなどを利用する際のエンドポイント
- CloudFront や Lambda エッジなど

## VPC とは

- virtual private cloud の頭文字
- AWS 上に仮想ネットワークを作成できるサービス
- VPC を作成するときはリージョンを選択。リージョンをまたぐことは出来ない
- VPC のなかで区切られたネットワーク(サブネット)を作成する

### サブネットとは

- VPC を細かく区切ったネットワーク
- サブネットの種類はパブリックサブネット、プライベートサブネット
- サブネットはアベイラビリティゾーンのなかで作成する
- 複数のアベイラビリティゾーンにサブネット作成が可能
- 1 つのアベイラビリティゾーンが利用できなくても他のアベイラビリティゾーンで稼働できる

## IP アドレスとは

- ネットワーク上の機器を識別するためのインターネット上の住所
- ネットワーク上で重複しない番号
- 32 ビットの整数値で構成される
- 32 ビットの IP アドレスを 8 ビットずつの 4 つの組に分け、ピリオドを入れて 10 進数で表現
- 0.0.0.0〜255.255.255.255 まで

### パブリック IP アドレスとは

- インターネットに接続する際に使用する IP アドレス
- 重複すると正しく通信できなくなる
- ICAN が IP アドレスを管理
- プロバイダーやサーバー事業者から貸し出される(AWS 上でも貸し出される)

### プライベート IP アドレスとは

- インターネットで使用されない IP アドレス
- 世界でユニークなアドレスでなくても良い
- 使用範囲内なら自由に使える
  - 10.0.0.0〜10.255.255.255
  - 172.16.0.0〜172.31.255.255
  - 192.168.0.0〜192.168.255.255
- 社内 LAN の構築やネットワークの実験時はプライベート IP アドレスを使用

## IP アドレスの範囲を表記

- ネットワークを構築する際は、そのネットワークで使う IP アドレスの範囲を決める
- IP アドレスはネットワーク部とホスト部に区分けることで範囲を表記
- 192.168.128.0〜192.168.128.255 の 256 個の IP アドレスの場合
  - 192.168.128 がネットワーク部
  - 可変部分の 0〜255 がホスト部

### 範囲の表記法 CIDR 表記

- IP アドレスの後ろに「/」を書き、その後ろにネットワーク部が先頭から何ビット目までなのかを記載
- 192.168.128.0〜192.168.128.255 の 256 個の IP アドレスの場合
  - 192.168.128.0/24
  - `/24`の部分がサブネットマスク

### 範囲の表記法 サブネットマスク表記

- サブネットマスクの数字は 2 進数表記したときにロックする桁数を指す
  - 10.0.0.255/8 の場合、`10`の 8 桁分(000010100)をロック
  - 10.0.0.255/16 の場合、`10.0`の 16 桁分(00001010,00000000)をロック
  - 10.0.0.255/24 の場合、`10.0.0`の 24 桁分(00001010,00000000,00000000)をロック
  - 残った数だけプライベート IP アドレスとして使用可能
- サブネットでグループ化する
  - `10.0.0.0/24`、`10.0.1.0/24`、`10.0.2.0/24`などグループ化することにより PC がどの IP アドレスに属するかが明確化される
- IP アドレスの後ろに「/」を書き、ネットワーク部を表すビットと同じ部分を 1 に、ホスト部を表すビットと同じ部分を 0 にする
- 192.168.128.0〜192.168.128.255 の 256 個の IP アドレスの場合
  - 192.168.128.0/255.255.255.0

## VPC トラフィック設定

- トラフィック設定はセキュリティグループまたはネットワーク ACL を使用

### セキュリティグループ

- ステートフル: 戻りトラフィックの考慮がいらない
- サーバー単位で適用
- 許可のみを In/Out で指定
- デフォルトとでは同じセキュリティグループ内通信のみ許可
- 必要な通信は許可設定が必要
- 全てのルールを適用

### ネットワーク ACL

- ステートレス: 戻りトラフィックも許可設定が必要
- サブネット単位で適用
- 許可と拒否を In/Out で指定
- デフォルトでは全ての送信元 IP を許可
- 番号の順序通りに適用

## VPC との外部接続

- `Direct Connect`と`VPCエンドポイント`と`NATゲートウェイ`の方法がある

### Direct Connect(専用線接続)

- Direct Connect ロケーションに Direct Connect デバイスと自社機器を物理的に置いて、自社オンプレ環境と接続させる
- お客様のデータセンターやオフィスを専用線などを介して AWS へプライベートに接続するサービス
- Direct Connect のメリット
  - 安価なアウトバウンドトラフィック料金
  - ネットワーク信頼性の向上
  - ネットワーク帯域幅の向上

### Direct Connect Gateway

- 同一アカウントに所属する複数リージョンの複数 AZ から複数リージョンの複数 VPC に接続が可能

### VPC エンドポイント

- グローバル IP を持つ AWS サービスに対して、VPC 内から直接アクセスするための出口
  - 例) VPC の外にある S3 にアクセスしたい
- 接続方法は`Gateway型`と`PrivateLink型`の 2 種類

## NAT ゲートウェイ

- プライベートサブネットのリソースがインターネットまたは AWS クラウドと通信が可能になる

## VPC Flow Logs

- ネットワークトラフィックを取得して Cloud Watch でモニタリングできるようにする機能
- RDS、Redshift、ElasticCache、WorkSpace のネットワークインターフェイストラフィックも取得可能
- 無料で利用可能なので VPC を作成したら`VPC Flow Logs`を設定する

## VPC を作成

| 画面             | 押下       |
| ---------------- | ---------- |
| サービス/VPC/VPC | VPC の作成 |

- 作業に入る前にリージョンを「東京」に変更
- `名前タグ`を入力
- `IPv4 CIDR ブロック`を「10.0.0.0/16」と入力

## サブネットを作成

- 作成した VPC をサブネットで分割する
- パブリックサブネットとプライベートサブネットを作成
- パブリックサブネットは WEB サーバーを設置してインターネットから接続
- プライベートサブネットは DB サーバーを設置してインターネットから隠す

### パブリックサブネットの作成

| 画面                    | 押下             |
| ----------------------- | ---------------- |
| サービス/VPC/サブネット | サブネットの作成 |

- `名前タグ`を入力
- `VPC`に作成した VPC を選択
- `アベイラビリティゾーン`で「ap-northeast-1a」を選択
- `IPv4 CIDR ブロック`で「10.0.10.0/24」と入力

### プライベートサブネットの作成

| 画面                    | 押下             |
| ----------------------- | ---------------- |
| サービス/VPC/サブネット | サブネットの作成 |

- `名前タグ`を入力
- `VPC`に作成した VPC を選択
- `アベイラビリティゾーン`で「ap-northeast-1a」を選択
- `IPv4 CIDR ブロック`で「10.0.20.0/24」と入力

## ルーティングを設定

- パブリックサブネットからインターネットに接続
- パブリックサブネットに設置する WEB サーバーに WordPress をインストール

### IP アドレスとルーティングとは

- インターネットではルーターが IP アドレスの行き先を管理
- ネットワークとネットワークが IP アドレスを通じて接続(ルーティング)
- ルートテーブルはどの IP アドレスがどこにあるかを管理
  - ルートテーブルは「宛先の IP アドレス」と「次のルーター(AWS はターゲット)」という書式で設定
  - 接続しているルート(local)
  - 他に接続しているルート
  - 0.0.0.0/0 のデフォルトルートはどのアドレスにも一致しない場合の経路
- パブリックサブネット用のルートテーブルを作成。0.0.0.0/0 をインターネットゲートウェイに向ける

### インターネットゲートウェイを VPC にアタッチ

| 画面                                    | 押下                             |
| --------------------------------------- | -------------------------------- |
| サービス/VPC/インターネットゲートウェイ | インターネットゲートウェイの作成 |

- `名前タグ`を入力
- 作成したゲートウェイを選択後、`アクション`の`VPCにアタッチ`を押下
- 作成した VPC を選択してアタッチ

### パブリックサブネット用のルートテーブルを作成

| 画面                        | 押下                 |
| --------------------------- | -------------------- |
| サービス/VPC/ルートテーブル | ルートテーブルの作成 |

- `名前タグ`を入力
- `VPC`で作成した VPC を選択
- 作成したルートテーブルを選択後、`サブネットの関連付け`タブを選択
  - `サブネットの関連付けを編集`を押下
  - 作成したパブリックサブネットを選択

### デフォルトルートをインターネットゲートウェイに設定

- パブリックサブネットのルートテーブルを選択
- `ルート`タブを選択
  - `ルートの編集`を押下
- ルートの編集
  - `ルートの追加`を押下
  - `送信先`を「0.0.0.0/0」と入力
  - `ターゲット`に作成したインターネットゲートウェイを選択

## VPC 設計ポイント

- プライベート IP アドレス範囲から指定
- IP アドレスの範囲は作成後は変更できないので大きめに設定。`/16`が推奨
- オンプレミスや他 VPC のレンジと重複しないようにする
- 異なるシステムの場合はアカウントを分ける
- PRO 環境と STG 環境は同一アカウントで VPC とリージョンを分ける

## サブネット設計のポイント

- 将来に必要な IP アドレス数を見積もる。`/24`が標準的
- サブネットの分割はルーティングとアベイラビリティゾーンを基準に行う
- インターネットアクセスの有無、拠点アクセスの有無などルーティングポリシーに応じて分割
- 高可用性のために 2 つ以上のアベイラビリティゾーンを使用
