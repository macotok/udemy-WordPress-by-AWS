# VPCネットワークを構築

## リージョンとは
- AWSの各サービスが提供されている地域のこと
- リージョンによって使えるサービスが異なる
- 最新機能はアメリカのリージョンで使える
- 日本の場合は東京リージョンを選択

## アベイラビリティゾーンとは
- AWSは各国にデータセンターをもっている
- 複数のデータセンターを束ねたものがアベイラビリティゾーン
- リージョンには２つ以上のアベイラビリティゾーンが物理的に離れて存在する
- 複数ある理由は災害があってアベイラビリティゾーンが使えなくても他のアベイラビリティゾーンが使えるため
- 東京には3つのアベイラビリティゾーンがある「ap-northeast-1a」「ap-northeast-1c」「ap-northeast-1d」

## VPCとは
- virtual private cloudの頭文字
- AWS上に仮想ネットワークを作成できるサービス
- VPCを作成するときはリージョンを選択。リージョンをまたぐことは出来ない
- VPCのなかで区切られたネットワーク(サブネット)をつくる

### サブネットとは
- VPCを細かく区切ったネットワーク
- サブネットの種類にパブリックサブネット、プライベートサブネットがある
- サブネットはアベイラビリティゾーンのなかで作る
- 複数のアベイラビリティゾーンにサブネットが作れる
- 1つのアベイラビリティゾーンが利用できなくても他のアベイラビリティゾーンで稼働できる

## IPアドレスとは
- ネットワーク上の機器を識別するためのインターネット上の住所
- ネットワーク上で重複しない番号
- 32ビットの整数値で構成される
- 32ビットのIPアドレスを8ビットずつの4つの組に分け、ピリオドを入れて10進数で表現
- 0.0.0.0〜255.255.255.255まで

### パブリックIPアドレスとは
- インターネットに接続する際に使用するIPアドレス
- 重複すると正しく通信できなくなる
- ICANがIPアドレスを管理
- プロバイダーやサーバー事業者から貸し出される(AWS上でも貸し出される)

### プライベートIPアドレスとは
- インターネットで使用されないIPアドレス
- 世界でユニークなアドレスでなくても良い
- 使用範囲内なら自由に使える
  - 10.0.0.0〜10.255.255.255
  - 172.16.0.0〜172.31.255.255
  - 192.168.0.0〜192.168.255.255
- 社内LANの構築やネットワークの実験時はプライベートIPアドレスを使用

## IPアドレスの範囲を表記
- ネットワークを構築する際はそのネットワークで使うIPアドレスの範囲を決める
- IPアドレスはネットワーク部とホスト部に区分けることで範囲を表記
- 192.168.128.0〜192.168.128.255の256個のIPアドレスの場合
  - 192.168.128がネットワーク部
  - 可変部分の0〜255がホスト部

### 範囲の表記法 CIDR表記
- IPアドレスの後ろに「/」を書き、その後ろにネットワーク部が先頭から何ビット目までなのかを記載
- 192.168.128.0〜192.168.128.255の256個のIPアドレスの場合
  - 192.168.128.0/24
  - `/24`の部分がサブネットマスク

### 範囲の表記法 サブネットマスク表記
- IPアドレスの後ろに「/」を書き、ネットワーク部を表すビットと同じ部分を1に、ホスト部を表すビットと同じ部分を0にする
- 192.168.128.0〜192.168.128.255の256個のIPアドレスの場合
  - 192.168.128.0/255.255.255.0

## VPCを作成

|  画面  |  押下  |
| ---- | ---- |
|  サービス/VPC  |  VPCの作成  |

- 作業に入る前にリージョンを東京に変更
- IPv4 CIDR ブロックを`10.0.0.0/16`と入力
- デフォルトでVPCが存在するが作成したVPCを選択

## サブネットを作成
- 作成したVPCをサブネットで分割する
- パブリックサブネットとプライベートサブネットを作成
- パブリックサブネットはWEBサーバーを設置してインターネットから接続
- プライベートサブネットはDBサーバーを設置してインターネットから隠す

### パブリックサブネットの作成

|  画面  |  押下  |
| ---- | ---- |
|  VPC/サブネット  |  サブネットの作成  |

- VPCの選択に作成したVPCを選択
- アベイラビリティゾーンで`ap-northeast-1a`を選択
- IPv4 CIDR ブロックで`10.0.10.0/24`と入力

### プライベートサブネットの作成

|  画面  |  押下  |
| ---- | ---- |
|  VPC/サブネット  |  サブネットの作成  |

- VPCの選択に作成したVPCを選択
- アベイラビリティゾーンで`ap-northeast-1a`を選択
- IPv4 CIDR ブロックで`10.0.20.0/24`と入力

## ルーティングを設定
- パブリックサブネットからインターネットに接続
- パブリックサブネットに設置するWEBサーバーにWordPressをインストール

### IPアドレスとルーティングとは
- インターネットではルーターがIPアドレスの行き先を管理
- ネットワークとネットワークがIPアドレスを通じて接続(ルーティング)
- ルートテーブルはどのIPアドレスがどこにあるかを管理
  - ルートテーブルは「宛先のIPアドレス」と「次のルーター(AWSはターゲット)」という書式で設定
  - 接続しているルート(local)
  - 他に接続しているルート
  - 0.0.0.0/0のデフォルトルートはどのアドレスにも一致しない場合の経路
- パブリックサブネット用のルートテーブルを作成。0.0.0.0/0をインターネットゲートウェイに向ける

### インターネットゲートウェイをVPCにアタッチ

|  画面  |  押下  |
| ---- | ---- |
|  VPC/インターネットゲートウェイ  |  インターネットゲートウェイの作成  |

- 作成したゲートウェイを選択
- アクション/VPCにアタッチ
- 作成したVPCを選択してアタッチ

### パブリックサブネット用のルートテーブルを作成

|  画面  |  押下  |
| ---- | ---- |
|  VPC/ルートテーブル  | ルートテーブルの作成  |

- 作成したVPCを選択
- 作成したルートテーブルを選択/サブネットの関連付けをクリック
- サブネットの関連付けを編集/パブリックサブネットを選択

### デフォルトルートをインターネットゲートウェイに設定
- パブリックサブネットのルートテーブルを選択
- ルート/ルートの編集
- ルートの追加
  - 送信先を0.0.0.0/0
  - ターゲットを作成したインターネットゲートウェイを選択

## VPC設計ポイント
- プライベートIPアドレス範囲から指定
- IPアドレスの範囲は作成後は変更できないので大きめに設定。`/16`が推奨
- オンプレミスや他VPCのレンジと重複しないようにする
- 異なるシステムの場合はアカウントを分ける
- PROとSTG環境の違いは同一アカウントでVPCとリージョンを分ける

## サブネット設計のポイント
- 将来に必要なIPアドレス数を見積もる。`/24`が標準的
- サブネットの分割はルーティングとアベイラビリティゾーンを基準に行う
- インターネットアクセスの有無、拠点アクセスの有無などのルーティングポリシーに応じて分割
- 高可用性のために2つ以上のアベイラビリティゾーンを使用
